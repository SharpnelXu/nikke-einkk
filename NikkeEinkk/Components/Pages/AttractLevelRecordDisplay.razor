@page "/misc/attract-level-record"
@rendermode RenderMode.InteractiveServer
@using NikkeEinkk.Components.Models
@using NikkeEinkk.Components.Models.Nikke
@using Microsoft.Extensions.Localization
@inject NikkeDatabaseProvider DbProvider
@inject IStringLocalizer<AttractLevelRecordDisplay> L

<PageTitle>@L["PageTitle"]</PageTitle>

<h1>@L["Title"]</h1>

<button class="toggle-btn" @onclick="ToggleExtraColumns">
    @(ShowExtraColumns ? L["HideExtraColumns"] : L["ShowAllColumns"])
</button>

<style>
    .toggle-btn {
        margin-bottom: 1rem;
        padding: 8px 16px;
        background-color: var(--primary-color);
        color: var(--on-primary-text);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: medium;
    }
    .toggle-btn:hover {
        background-color: var(--primary-hover-color);
        color: var(--on-primary-text);
    }
    .attract-table {
        border-collapse: collapse;
        width: 100%;
        font-family: Arial, sans-serif;
    }
    .attract-table th, .attract-table td {
        border: 1px solid var(--table-border);
        padding: 8px;
        text-align: center;
    }
    .attract-table th {
        background-color: var(--primary-color);
        color: var(--on-primary-text);
    }
    .attract-table tr:nth-child(even) {
        background-color: var(--table-row-bg2);
    }
    .attract-table tr:hover {
        background-color: var(--table-hover-bg);
    }
</style>

<table class="attract-table">
    <thead>
        <tr>
            @if (ShowExtraColumns)
            {
                <th rowspan="2">@L["ID"]</th>
            }
            <th rowspan="2">@L["Level"]</th>
            <th rowspan="2">@L["Total"]</th>
            <th rowspan="2">@L["Next"]</th>
            <th colspan="@(ShowExtraColumns ? 6 : 3)">@L["Attacker"]</th>
            <th colspan="@(ShowExtraColumns ? 6 : 3)">@L["Defender"]</th>
            <th colspan="@(ShowExtraColumns ? 6 : 3)">@L["Supporter"]</th>
        </tr>
        <tr>
            <th>@L["HP"]</th>
            <th>@L["ATK"]</th>
            <th>@L["DEF"]</th>
            @if (ShowExtraColumns)
            {
                <th>@L["EnergyResist"]</th>
                <th>@L["MetalResist"]</th>
                <th>@L["BioResist"]</th>
            }
            <th>@L["HP"]</th>
            <th>@L["ATK"]</th>
            <th>@L["DEF"]</th>
            @if (ShowExtraColumns)
            {
                <th>@L["EnergyResist"]</th>
                <th>@L["MetalResist"]</th>
                <th>@L["BioResist"]</th>
            }
            <th>@L["HP"]</th>
            <th>@L["ATK"]</th>
            <th>@L["DEF"]</th>
            @if (ShowExtraColumns)
            {
                <th>@L["EnergyResist"]</th>
                <th>@L["MetalResist"]</th>
                <th>@L["BioResist"]</th>
            }
        </tr>
    </thead>
    <tbody>
        @foreach (var record in Records)
        {
            <tr>
                @if (ShowExtraColumns)
                {
                    <td>@record.Id</td>
                }
                <td>@record.AttractiveLevel</td>
                <td>@GetAccumulatedPoints(record.AttractiveLevel)</td>
                <td>@record.AttractivePoint</td>
                <td>@record.AttackerHpRate</td>
                <td>@record.AttackerAttackRate</td>
                <td>@record.AttackerDefenceRate</td>
                @if (ShowExtraColumns)
                {
                    <td>@record.AttackerEnergyResistRate</td>
                    <td>@record.AttackerMetalResistRate</td>
                    <td>@record.AttackerBioResistRate</td>
                }
                <td>@record.DefenderHpRate</td>
                <td>@record.DefenderAttackRate</td>
                <td>@record.DefenderDefenceRate</td>
                @if (ShowExtraColumns)
                {
                    <td>@record.DefenderEnergyResistRate</td>
                    <td>@record.DefenderMetalResistRate</td>
                    <td>@record.DefenderBioResistRate</td>
                }
                <td>@record.SupporterHpRate</td>
                <td>@record.SupporterAttackRate</td>
                <td>@record.SupporterDefenceRate</td>
                @if (ShowExtraColumns)
                {
                    <td>@record.SupporterEnergyResistRate</td>
                    <td>@record.SupporterMetalResistRate</td>
                    <td>@record.SupporterBioResistRate</td>
                }
            </tr>
        }
    </tbody>
</table>

@code {
    private IEnumerable<AttractiveLevelRecord> Records { get; set; } = [];
    private Dictionary<int, int> AccumulatedPoints { get; set; } = new();
    private bool ShowExtraColumns { get; set; }

    protected override void OnInitialized()
    {
        Records = DbProvider.GetDatabase(true).AttractiveLevelTable.Values;

        // Calculate accumulated points for each level
        int total = 0;
        foreach (var record in Records)
        {
            AccumulatedPoints[record.AttractiveLevel] = total;
            total += record.AttractivePoint;
        }
    }

    private void ToggleExtraColumns()
    {
        ShowExtraColumns = !ShowExtraColumns;
    }

    private int GetAccumulatedPoints(int level)
    {
        return AccumulatedPoints.GetValueOrDefault(level, 0);
    }
}

